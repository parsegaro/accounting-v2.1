(function(U){"use strict";var $=(e=>(e.Admin="admin",e.Accountant="accountant",e.Doctor="doctor",e))($||{});const O=[{name:"مدیر سیستم",email:"admin@clinic.com",passwordHash:"nimda",role:$.Admin}],J=[{id:1,name:"تامین اجتماعی"},{id:2,name:"خدمات درمانی"},{id:3,name:"بیمه ایران"},{id:4,name:"بیمه آسیا"}],_=[{id:1,name:"دارایی‌ها",type:"دارایی‌ها",code:"1",parentId:null},{id:2,name:"بدهی‌ها",type:"بدهی‌ها",code:"2",parentId:null},{id:4,name:"درآمد",type:"درآمد",code:"4",parentId:null},{id:5,name:"هزینه",type:"هزینه",code:"5",parentId:null},{id:10,name:"دارایی‌های جاری",type:"دارایی‌ها",code:"10",parentId:1},{id:11,name:"دارایی‌های ثابت",type:"دارایی‌ها",code:"11",parentId:1},{id:1010,name:"صندوق کلینیک",type:"دارایی‌ها",code:"1010",parentId:10},{id:1020,name:"حساب بانک ملت",type:"دارایی‌ها",code:"1020",parentId:10},{id:1030,name:"حساب‌های دریافتنی",type:"دارایی‌ها",code:"1030",parentId:10},{id:20,name:"بدهی‌های جاری",type:"بدهی‌ها",code:"20",parentId:2},{id:2010,name:"حساب‌های پرداختنی",type:"بدهی‌ها",code:"2010",parentId:20},{id:2020,name:"حقوق پرداختنی",type:"بدهی‌ها",code:"2020",parentId:20},{id:4010,name:"درآمد خدمات پزشکی",type:"درآمد",code:"4010",parentId:4},{id:4020,name:"درآمد فروش کالا",type:"درآمد",code:"4020",parentId:4},{id:4030,name:"درآمد عمومی",type:"درآمد",code:"4030",parentId:4},{id:5010,name:"هزینه حقوق و دستمزد",type:"هزینه",code:"5010",parentId:5},{id:5020,name:"هزینه اجاره",type:"هزینه",code:"5020",parentId:5},{id:5030,name:"هزینه قبوض و نگهداری",type:"هزینه",code:"5030",parentId:5},{id:5040,name:"هزینه خرید مواد مصرفی",type:"هزینه",code:"5040",parentId:5}],K=[{id:1,name:"تجهیزات پزشکی سینا",contactPerson:"آقای شریفی",phone:"021-88776655"},{id:2,name:"داروخانه رازی",contactPerson:"دکتر احمدی",phone:"021-44332211"}],Z=[{id:1,name:"علی رضایی",nationalId:"1234567890",phone:"09123456789",insuranceCompany:"تامین اجتماعی",tags:["پرونده قدیمی"]},{id:2,name:"مریم حسینی",nationalId:"0987654321",phone:"09129876543",insuranceCompany:"آزاد"},{id:3,name:"زهرا احمدی",nationalId:"1122334455",phone:"09121122334",insuranceCompany:"خدمات درمانی"}],G=[{id:1,name:"سارا محمدی",role:"پرستار",salaryType:"monthly",baseSalary:12e6,housingAllowance:15e5,childAllowance:5e5,taxRate:10,insuranceDeduction:98e4,nextPaymentDate:"1403/05/30"},{id:2,name:"رضا کریمی",role:"پذیرش",salaryType:"hourly",baseSalary:6e4,defaultMonthlyHours:150,housingAllowance:1e6,childAllowance:0,taxRate:10,insuranceDeduction:7e5,nextPaymentDate:"1403/05/30"}],V=[{id:1,name:"دکتر احمد علوی",specialty:"متخصص داخلی",taxRate:10,nextPaymentDate:"1403/06/15"},{id:2,name:"دکتر فاطمه زمانی",specialty:"متخصص اطفال",taxRate:10,nextPaymentDate:"1403/06/15"}],W=[{id:1,expenseAccountId:5010,description:"حقوق خرداد ماه پرسنل",amount:15e6,date:"1403/04/05",fromAccountId:1020,toEntityId:"employee-1",tags:["حقوق"]},{id:2,expenseAccountId:5040,description:"خرید سرنگ و گاز استریل",amount:25e5,date:"1403/04/08",fromAccountId:1010,toEntityId:"supplier-1",tags:["خرید","مصرفی"]}],z=[{id:1,date:"1403/05/08",amount:14e4,method:"کارت‌خوان",type:"دریافت",description:"بابت فاکتور #101",entityId:"patient-1",accountId:1020,invoiceId:"inv-mock-101",tags:["فاکتور"]},{id:2,date:"1403/05/10",amount:5e4,method:"نقدی",type:"دریافت",description:"بابت فاکتور #103",entityId:"patient-3",accountId:1010,invoiceId:"inv-mock-103",tags:["فاکتور","نقدی"]}],Y=[{id:1,name:"ویزیت عمومی",tariffs:{آزاد:15e4,"تامین اجتماعی":7e4,"خدمات درمانی":65e3}},{id:2,name:"ویزیت تخصصی",tariffs:{آزاد:3e5,"تامین اجتماعی":12e4,"خدمات درمانی":11e4},commissions:[{personId:"doctor-1",type:"percentage",value:35}]},{id:3,name:"تزریقات",tariffs:{آزاد:5e4,"تامین اجتماعی":2e4,"خدمات درمانی":18e3},commissions:[{personId:"employee-1",type:"fixed",value:5e3}]},{id:4,name:"سرم تراپی",tariffs:{آزاد:1e5,"تامین اجتماعی":45e3,"خدمات درمانی":4e4}}],X=[{id:"inv-mock-101",recipientName:"علی رضایی",date:"1403/05/08",items:[{type:"service",id:2,name:"ویزیت تخصصی",quantity:1,price:12e4,doctorId:1},{type:"service",id:3,name:"تزریقات",quantity:1,price:2e4}],totalAmount:14e4,discount:0,insuranceShare:21e4,patientShare:14e4,paidAmount:14e4,status:"پرداخت شده",tariffType:"تامین اجتماعی"},{id:"inv-mock-102",recipientName:"مریم حسینی",date:"1403/05/09",items:[{type:"service",id:1,name:"ویزیت عمومی",quantity:1,price:15e4,doctorId:2}],totalAmount:15e4,discount:1e4,insuranceShare:0,patientShare:14e4,paidAmount:0,status:"در انتظار پرداخت",tags:["پیگیری شود"],tariffType:"آزاد"},{id:"inv-mock-103",recipientName:"زهرا احمدی",date:"1403/05/10",items:[{type:"service",id:4,name:"سرم تراپی",quantity:2,price:8e4,doctorId:1}],totalAmount:8e4,discount:0,insuranceShare:12e4,patientShare:8e4,paidAmount:5e4,status:"پرداخت ناقص",tariffType:"خدمات درمانی"}],ee=[{id:1,date:"1403/05/08",description:"دریافت بابت فاکتور #101 از علی رضایی",accountId:1020,debit:14e4,credit:0,referenceId:"payment-1"},{id:2,date:"1403/05/08",description:"تسویه فاکتور #101",accountId:1030,debit:0,credit:14e4,referenceId:"payment-1"},{id:3,date:"1403/04/08",description:"خرید سرنگ و گاز استریل از تجهیزات پزشکی سینا",accountId:5040,debit:25e5,credit:0,referenceId:"expense-2"},{id:4,date:"1403/04/08",description:"پرداخت از صندوق بابت خرید مواد مصرفی",accountId:1010,debit:0,credit:25e5,referenceId:"expense-2"},{id:5,date:"1403/05/12",description:"سند دستی: اصلاح حساب",accountId:5020,debit:5e4,credit:0}],te=[{id:1,insuranceCompanyId:1,submissionDate:"1403/05/09",status:"ارسال شده",expectedAmount:14e4,items:[{type:"service",itemId:2,description:"ویزیت تخصصی",quantity:1,unitPrice:12e4,totalPrice:12e4},{type:"service",itemId:3,description:"تزریقات",quantity:1,unitPrice:2e4,totalPrice:2e4}],notes:"شامل فاکتورهای ابتدای ماه."},{id:2,insuranceCompanyId:2,submissionDate:"1403/05/11",status:"در حال بررسی",expectedAmount:8e4,items:[{type:"service",itemId:4,description:"سرم تراپی",quantity:2,unitPrice:4e4,totalPrice:8e4}]}],ne=[{id:1,name:"سرنگ ۵ سی‌سی",quantity:150,reorderPoint:50,purchasePrice:1e4,salePrice:15e3},{id:2,name:"گاز استریل",quantity:80,reorderPoint:40,purchasePrice:3e3,salePrice:5e3},{id:3,name:"آنژیوکت صورتی",quantity:35,reorderPoint:20,purchasePrice:18e3,salePrice:25e3}],ae=[{id:1,name:"پکیج سرماخوردگی",items:[{type:"service",id:1,quantity:1},{type:"service",id:4,quantity:1}]},{id:2,name:"تزریقات عمومی",items:[{type:"service",id:3,quantity:1},{type:"inventory",id:1,quantity:1}]}],ie=[{id:1,employeeId:1,employeeName:"سارا محمدی",date:"1403/05/05",payPeriod:"مرداد 1403",baseSalary:12e6,housingAllowance:15e5,childAllowance:5e5,otherAllowances:0,commissionTotal:0,totalEarnings:14e6,taxDeduction:14e5,insuranceDeduction:98e4,advanceDeduction:0,otherDeductions:0,totalDeductions:238e4,netPayable:1162e4,status:"در انتظار پرداخت"}],oe=[{id:1,type:"payable",entityId:"supplier-2",description:"بابت خرید داروهای ماه گذشته",amount:45e5,issueDate:"1403/05/01",dueDate:"1403/06/01",status:"در انتظار"},{id:2,type:"receivable",entityId:"patient-2",description:"طلب بابت خدمات آتی",amount:12e5,issueDate:"1403/05/15",dueDate:"1403/05/25",status:"در انتظار"}],se=[{id:1,name:"بودجه ماهانه مواد مصرفی",expenseAccountId:5040,limit:5e6,period:"monthly",startDate:"1403/05/01"},{id:2,name:"بودجه ماهانه قبوض و نگهداری",expenseAccountId:5030,limit:2e6,period:"monthly",startDate:"1403/05/01"},{id:3,name:"بودجه سالانه اجاره",expenseAccountId:5020,limit:12e7,period:"yearly",startDate:"1403/01/01"}],ce=[{id:1,name:"آزمایش خون بیمار رضایی",uploadDate:"1403/05/01",description:"نتیجه آزمایش خون کامل مربوط به پرونده پزشکی آقای علی رضایی.",fileData:"data:application/pdf;base64,JVBERi0xLjQKJdPr6eEKMSAwIG9iago8PAovVHlwZSAvQ2F0YWxvZwovT3V0bGluZXMgMiAwIFIKL1BhZ2VzIDMgMCBS...",fileType:"application/pdf",entityId:"patient-1",tags:["آزمایش","خون"]},{id:2,name:"قرارداد تجهیزات پزشکی",uploadDate:"1403/04/15",description:"قرارداد خرید دستگاه سونوگرافی از شرکت تجهیزات پزشکی سینا.",fileData:"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/wAALCAABAAEBAREA/8QAFAABAAAAAAAAAAAAAAAAAAAAA//EABQQAQAAAAAAAAAAAAAAAAAAAAD/2gAIAQEAAD8AAn/C/9s=",fileType:"image/jpeg",entityId:"supplier-1",tags:["قرارداد","خرید"]}],de=[],re=[],ue="ClinicAccountingDB",pe=3,v=["users","accounts","patients","services","invoices","payments","claims","inventory","employees","invoiceTemplates","ledger","payslips","suppliers","expenses","payablesReceivables","doctors","insuranceCompanies","incomeRecords","transfers","budgets","settings","documents"];let g;const le=e=>({users:O,accounts:_,ledger:ee,patients:Z,employees:G,doctors:V,suppliers:K,services:Y,inventory:ne,invoices:X,payments:z,expenses:W,claims:te,invoiceTemplates:ae,payslips:ie,payablesReceivables:oe,insuranceCompanies:J,incomeRecords:de,transfers:re,budgets:se,documents:ce})[e],me=e=>{console.log("Seeding database with initial mock data..."),v.forEach(t=>{const n=le(t);if(n){const a=e.objectStore(t);n.forEach(o=>{a.add(o)})}}),console.log("Database seeding complete.")};async function b(){g||(g=await U.openDB(ue,pe,{upgrade(e,t,n,a){console.log(`Upgrading database from version ${t} to ${n}...`),v.forEach(o=>{e.objectStoreNames.contains(o)||(console.log(`Creating store: ${o}`),o==="settings"||o==="invoices"?e.createObjectStore(o,{keyPath:"id"}):e.createObjectStore(o,{keyPath:"id",autoIncrement:!0}))}),t===0&&me(a)}}))}async function m(e){return g.getAll(e)}async function u(e,t){return g.get(e,t)}async function p(e,t){return g.add(e,t)}async function l(e,t,n){return g.put(e,t,n)}async function I(e,t){return g.delete(e,t)}async function ye(e){return g.clear(e)}const h=()=>new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date),E=e=>e.split("").reverse().join(""),we=async(e,t)=>{await b();const a=(await m("users")).find(d=>d.email.toLowerCase()===e.toLowerCase());if(!a)throw new Error("کاربری با این ایمیل یافت نشد.");if(a.passwordHash!==E(t))throw new Error("رمز عبور اشتباه است.");const o=`mock-token:${a.id}:${a.email}:${Date.now()}`,{passwordHash:i,...s}=a;return{user:s,token:o}},Ie=async(e,t,n)=>{if(await b(),(await m("users")).find(w=>w.email.toLowerCase()===t.toLowerCase()))throw new Error("این ایمیل قبلا ثبت نام شده است.");const o={name:e,email:t,passwordHash:E(n),role:$.Accountant},i=await p("users",o),s={...o,id:i},d=`mock-token:${s.id}:${s.email}:${Date.now()}`,{passwordHash:c,...r}=s;return{user:r,token:d}},fe=async e=>{if(!e.startsWith("mock-token:"))return null;const t=e.split(":");if(t.length<3)return null;const n=parseInt(t[1],10);if(isNaN(n))return null;await b();const a=await u("users",n);if(a){const{passwordHash:o,...i}=a;return i}return null},ge=async()=>{await b();const e=v.filter(i=>i!=="users"),t=e.map(i=>m(i)),n=await Promise.all(t),a={};e.forEach((i,s)=>{a[i]=n[s]});const o=await u("settings","config");return a.settings=o?[o]:[],a},y=e=>({getAll:async()=>m(e),add:async t=>{const n=await p(e,t);return{...t,id:n}},update:async t=>(await l(e,t),t),remove:async t=>I(e,t)}),Ae={...y("accounts"),update:async e=>{const t=await u("accounts",e.id);if(t){const n={...t,name:e.name,code:e.code};return await l("accounts",n),n}throw new Error("Account not found")}},S=y("patients"),T=y("employees"),x=y("doctors"),R=y("suppliers"),ve=y("services"),he=y("invoiceTemplates"),De=y("budgets"),C=y("documents"),Pe=y("insuranceCompanies"),be=y("ledger"),ke=y("claims"),$e=y("payslips"),L=y("payablesReceivables"),D={...y("inventory"),updateQuantity:async(e,t,n)=>{const a=await u("inventory",e);if(!a)throw new Error("Inventory item not found");const o={...a,quantity:a.quantity+(n==="in"?t:-t)};return await l("inventory",o),o}},Ee=async e=>{const t=`F-${Date.now()}`,n={...e,id:t};await p("invoices",n);let a=[];for(const o of n.items)if(o.type==="inventory"){const i=await D.updateQuantity(o.id,o.quantity,"out");a.push(i)}return{newInvoice:n,updatedInventory:a}},B=async e=>{const t=await u("invoices",e.id),n={};if(t)for(const o of t.items)o.type==="inventory"&&(n[o.id]={change:o.quantity,type:"in"});for(const o of e.items)if(o.type==="inventory"){const i=n[o.id]||{change:0,type:"out"};i.change-=o.quantity,i.change>0?i.type="in":(i.type="out",i.change=Math.abs(i.change))}let a=[];for(const[o,i]of Object.entries(n))if(i.change!==0){const s=await D.updateQuantity(Number(o),i.change,i.type);a.push(s)}return await l("invoices",e),{updatedInvoice:e,updatedInventory:a}},Se=async e=>{const t=await u("invoices",e);if(!t)return{updatedInventory:[],deletedPaymentIds:[]};const a=(await m("payments")).filter(c=>c.invoiceId===e),o=a.map(c=>c.id),i=a.map(async c=>{const r=(await m("ledger")).filter(w=>w.referenceId===`payment-${c.id}`);await Promise.all(r.map(w=>I("ledger",w.id)))});await Promise.all(i),await Promise.all(a.map(c=>I("payments",c.id)));const s=t.items.filter(c=>c.type==="inventory").map(c=>D.updateQuantity(c.id,c.quantity,"in")),d=await Promise.all(s);return await I("invoices",e),{updatedInventory:d,deletedPaymentIds:o}},k=async e=>{const t=await p("payments",e),n={...e,id:t};let a=[],o=null;const i=e.description||(e.type==="دریافت"?"دریافت وجه":"پرداخت وجه"),s={date:e.date,description:i,accountId:e.accountId,debit:e.type==="دریافت"?e.amount:0,credit:e.type==="پرداخت"?e.amount:0,referenceId:`payment-${t}`},d=await p("ledger",s);if(a.push({...s,id:d}),e.invoiceId){const c=await u("invoices",e.invoiceId);if(c){const r=c.paidAmount+e.amount,A=r>=c.patientShare?"پرداخت شده":"پرداخت ناقص";o={...c,paidAmount:r,status:A},await l("invoices",o);const f={date:e.date,description:`تسویه فاکتور: ${e.invoiceId}`,accountId:1030,debit:0,credit:e.amount,referenceId:`payment-${t}`},P=await p("ledger",f);a.push({...f,id:P})}}return{newPayment:n,newLedgerEntries:a,updatedInvoice:o}},M=async e=>{const t=await u("payments",e.id);if(!t)throw new Error("Payment not found for update.");let n=null;if(t.invoiceId){const r=await u("invoices",t.invoiceId);if(r){const w=r.paidAmount-t.amount,A=w<=0?"در انتظار پرداخت":"پرداخت ناقص";n={...r,paidAmount:w,status:A},await l("invoices",n)}}const a=(await m("ledger")).filter(r=>r.referenceId===`payment-${e.id}`),o=a.map(r=>r.id);await Promise.all(a.map(r=>I("ledger",r.id))),await l("payments",e);let i=[];const s=e.description||(e.type==="دریافت"?"دریافت وجه":"پرداخت وجه"),d=await p("ledger",{date:e.date,description:s,accountId:e.accountId,debit:e.type==="دریافت"?e.amount:0,credit:e.type==="پرداخت"?e.amount:0,referenceId:`payment-${e.id}`});i.push({...await u("ledger",d)});let c=null;if(e.invoiceId){const r=n&&n.id===e.invoiceId?n:await u("invoices",e.invoiceId);if(r){const w=r.paidAmount+e.amount,A=w>=r.patientShare?"پرداخت شده":"پرداخت ناقص";c={...r,paidAmount:w,status:A},await l("invoices",c);const f=await p("ledger",{date:e.date,description:`تسویه فاکتور: ${e.invoiceId}`,accountId:1030,debit:0,credit:e.amount,referenceId:`payment-${e.id}`});i.push({...await u("ledger",f)})}}return{updatedPayment:e,updatedInvoice:c,newLedgerEntries:i,deletedLedgerEntryIds:o}},Te=async e=>{const t=await u("payments",e);let n=null;if(t){if(t.invoiceId){const o=await u("invoices",t.invoiceId);if(o){const i=o.paidAmount-t.amount,s=i<=0?"در انتظار پرداخت":i>=o.patientShare?"پرداخت شده":"پرداخت ناقص";n={...o,paidAmount:i,status:s},await l("invoices",n)}}await I("payments",e);const a=(await m("ledger")).filter(o=>o.referenceId===`payment-${e}`);for(const o of a)await I("ledger",o.id)}return{updatedInvoice:n}},xe=async e=>{const t=await p("expenses",e),n={...e,id:t};let a=[];const o={date:e.date,description:e.description,accountId:e.expenseAccountId,debit:e.amount,credit:0,referenceId:`expense-${t}`},i=await p("ledger",o);a.push({...o,id:i});const s={date:e.date,description:`پرداخت بابت: ${e.description}`,accountId:e.fromAccountId,debit:0,credit:e.amount,referenceId:`expense-${t}`},d=await p("ledger",s);return a.push({...s,id:d}),{newExpense:n,newLedgerEntries:a}},q=async e=>{const t=(await m("ledger")).filter(n=>n.referenceId===`expense-${e.id}`);for(const n of t)await I("ledger",n.id);return await p("ledger",{date:e.date,description:e.description,accountId:e.expenseAccountId,debit:e.amount,credit:0,referenceId:`expense-${e.id}`}),await p("ledger",{date:e.date,description:`پرداخت بابت: ${e.description}`,accountId:e.fromAccountId,debit:0,credit:e.amount,referenceId:`expense-${e.id}`}),await l("expenses",e),e},Re=async e=>{await I("expenses",e);const t=(await m("ledger")).filter(n=>n.referenceId===`expense-${e}`);for(const n of t)await I("ledger",n.id)},Ce=async e=>{const t=await p("transfers",e),n={...e,id:t};let a=[];const o=e.description||"انتقال وجه",i=await p("ledger",{date:e.date,description:`برداشت: ${o}`,accountId:e.fromAccountId,debit:0,credit:e.amount,referenceId:`transfer-${t}`});a.push({...await u("ledger",i)});const s=await p("ledger",{date:e.date,description:`واریز: ${o}`,accountId:e.toAccountId,debit:e.amount,credit:0,referenceId:`transfer-${t}`});return a.push({...await u("ledger",s)}),{newTransfer:n,newLedgerEntries:a}},Q=async e=>{const t=(await m("ledger")).filter(a=>a.referenceId===`transfer-${e.id}`);for(const a of t)await I("ledger",a.id);const n=e.description||"انتقال وجه";return await p("ledger",{date:e.date,description:`برداشت: ${n}`,accountId:e.fromAccountId,debit:0,credit:e.amount,referenceId:`transfer-${e.id}`}),await p("ledger",{date:e.date,description:`واریز: ${n}`,accountId:e.toAccountId,debit:e.amount,credit:0,referenceId:`transfer-${e.id}`}),await l("transfers",e),e},Le={login:we,signup:Ie,getUserFromToken:fe,getAllData:ge,accounts:Ae,patients:S,employees:T,doctors:x,suppliers:R,services:ve,invoiceTemplates:he,budgets:De,documents:C,insuranceCompanies:Pe,ledger:be,claims:ke,payslips:$e,payablesReceivables:L,inventory:D,addInvoice:Ee,updateInvoice:B,deleteInvoice:Se,addPayment:k,updatePayment:M,deletePayment:Te,addExpense:xe,updateExpense:q,deleteExpense:Re,addTransfer:Ce,updateTransfer:Q,deleteTransfer:async e=>{await I("transfers",e);const t=(await m("ledger")).filter(n=>n.referenceId===`transfer-${e}`);for(const n of t)await I("ledger",n.id)},addIncomeRecord:async e=>{const{newPayment:t,newLedgerEntries:n}=await k({date:e.date,amount:e.totalAmount,method:e.paymentMethod,type:"دریافت",description:e.description||"ثبت درآمد روزانه",entityId:"custom-income",accountId:e.paymentAccountId}),a=await p("incomeRecords",{...e,paymentId:t.id}),o={...e,paymentId:t.id,id:a};let i=[];for(const s of e.items)if(s.type==="inventory"){const d=await D.updateQuantity(s.id,s.quantity,"out");i.push(d)}return{newRecord:o,newPayment:t,newLedgerEntries:n,updatedInventory:i}},updateClaim:async e=>{const t=await u("claims",e.id);let n=null;if((t==null?void 0:t.status)!=="پرداخت شده"&&e.status==="پرداخت شده"&&e.receivedAmount){n=[];const a=await p("ledger",{date:e.receivedDate||h(),description:`دریافت وجه از بیمه #${e.id}`,accountId:1020,debit:e.receivedAmount,credit:0,referenceId:`claim-${e.id}`});n.push(await u("ledger",a));const o=await p("ledger",{date:e.receivedDate||h(),description:`تسویه مطالبات بیمه #${e.id}`,accountId:1030,debit:0,credit:e.receivedAmount,referenceId:`claim-${e.id}`});n.push(await u("ledger",o))}return await l("claims",e),{updatedClaim:e,newLedgerEntries:n}},payPayslip:async(e,t,n)=>{const a=await u("payslips",e);if(!a||a.status==="پرداخت شده")throw new Error("Payslip not found or already paid");const{newPayment:o,newLedgerEntries:i}=await k({date:h(),amount:a.netPayable,method:n,type:"پرداخت",description:`پرداخت حقوق ${a.payPeriod} به ${a.employeeName}`,entityId:`employee-${a.employeeId}`,accountId:t}),s={...a,status:"پرداخت شده",paymentId:o.id};return await l("payslips",s),{updatedPayslip:s,newPayment:o,newLedgerEntries:i}},generateDueEmployeePayslips:async()=>{const e=h(),t=parseInt(e.replace(/\//g,""),10),n=await m("employees"),a=await m("payslips"),o=[];for(const i of n){if(!i.nextPaymentDate)continue;if(parseInt(i.nextPaymentDate.replace(/\//g,""),10)<=t){const[d,c,r]=i.nextPaymentDate.split("/").map(Number),w=`${new Intl.DateTimeFormat("fa-IR",{month:"long"}).format(new Date(d,c-1,r))} ${d}`;if(!a.find(f=>f.employeeId===i.id&&f.payPeriod===w)){const f=i.salaryType==="hourly"?(i.defaultMonthlyHours||160)*i.baseSalary:i.baseSalary,P=f+(i.housingAllowance||0)+(i.childAllowance||0),H=P*(i.taxRate/100),F=H+(i.insuranceDeduction||0),Be=P-F,N={employeeId:i.id,employeeName:i.name,date:e,payPeriod:w,baseSalary:f,hoursWorked:i.salaryType==="hourly"?i.defaultMonthlyHours||160:void 0,housingAllowance:i.housingAllowance||0,childAllowance:i.childAllowance||0,commissionTotal:0,otherAllowances:0,totalEarnings:P,taxDeduction:H,insuranceDeduction:i.insuranceDeduction||0,otherDeductions:0,advanceDeduction:0,totalDeductions:F,netPayable:Be,status:"در انتظار پرداخت"},Me=await p("payslips",N);o.push({...N,id:Me});const j=new Date(d,c,r),qe=new Date(j.setMonth(j.getMonth()+1));i.nextPaymentDate=new Intl.DateTimeFormat("fa-IR-u-nu-latn",{year:"numeric",month:"2-digit",day:"2-digit"}).format(qe),await l("employees",i)}}}return o},markAsPaid:async(e,t,n)=>{const a=await u("payablesReceivables",e);if(!a)throw new Error("Item not found");const{newPayment:o,newLedgerEntries:i}=await k({date:h(),amount:a.amount,method:t,type:a.type==="payable"?"پرداخت":"دریافت",description:`تسویه حساب: ${a.description}`,entityId:a.entityId,accountId:n,payableReceivableId:a.id}),s={...a,status:"پرداخت شده",paymentId:o.id};return await l("payablesReceivables",s),{updatedPR:s,newPayment:o,newLedgerEntries:i}},updateSettings:async e=>{const n={...await u("settings","config")||{id:"config"},...e};return await l("settings",n,"config"),n},backupData:async()=>{const e={};for(const t of v)e[t]=await m(t);return JSON.stringify(e,null,2)},restoreData:async e=>{const t=JSON.parse(e);for(const n of v)if(await ye(n),t[n])for(const a of t[n])await l(n,a)},updateTags:async(e,t,n)=>{const o={patient:{store:"patients",api:S},employee:{store:"employees",api:T},doctor:{store:"doctors",api:x},supplier:{store:"suppliers",api:R},invoice:{store:"invoices",api:{update:B}},expense:{store:"expenses",api:{update:q}},payment:{store:"payments",api:{update:M}},transfer:{store:"transfers",api:{update:Q}},payableReceivable:{store:"payablesReceivables",api:L},document:{store:"documents",api:C}}[e];if(o){const i=await u(o.store,t);if(i){const s={...i,tags:n},d=await o.api.update(s);return d.updatedInvoice||d.updatedPayment||d}}throw new Error(`Invalid entity type for tagging: ${e}`)}};self.onmessage=async e=>{const{action:t,payload:n,id:a}=e.data;try{const o=t.split(".");let i=Le;for(const d of o)if(i&&typeof i=="object"&&d in i)i=i[d];else throw new Error(`Action part "${d}" not found in action "${t}".`);if(typeof i!="function")throw new Error(`Action "${t}" is not a function.`);const s=await i(...n);self.postMessage({id:a,payload:s})}catch(o){self.postMessage({id:a,error:o.message||"An unknown error occurred in the worker."})}}})(idb_8_0_0);
